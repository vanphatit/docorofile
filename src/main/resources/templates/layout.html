<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="en"
      class="light-style layout-navbar-fixed layout-menu-fixed layout-wide"
      dir="ltr"
      data-theme="theme-default"
      data-template="vertical-menu-template"
      data-style="light">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title th:utext="${pageTitle}">DoCoroFile</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" th:href="@{/images/logo.png}" />
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" th:href="@{/images/logo.png}"/>

    <!-- Fonts -->
    <link rel="preconnect" th:href="@{https://fonts.googleapis.com}"/>
    <link rel="preconnect" th:href="@{https://fonts.gstatic.com}" crossorigin/>
    <!--    <link-->
    <!--            th:href="@{https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&ampdisplay=swap}"-->
    <!--            rel="stylesheet" />-->

    <!-- Icons -->
    <link rel="stylesheet" th:href="@{/assets/vendor/fonts/remixicon/remixicon.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/fonts/flag-icons.css}"/>

    <!-- Menu waves for no-customizer fix -->
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/node-waves/node-waves.css}"/>

    <!-- Core CSS -->
    <link rel="stylesheet" th:href="@{/assets/vendor/css/rtl/core.css}" class="template-customizer-core-css"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/css/rtl/theme-default.css}" class="template-customizer-theme-css"/>
    <link rel="stylesheet" th:href="@{/assets/css/demo.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/css/pages/front-page.css}"/>

    <!-- Vendors CSS -->
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/typeahead-js/typeahead.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/datatables-bs5/datatables.bootstrap5.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/datatables-checkboxes-jquery/datatables.checkboxes.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/select2/select2.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/@form-validation/form-validation.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/animate-css/animate.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/sweetalert2/sweetalert2.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/tagify/tagify.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/nouislider/nouislider.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/swiper/swiper.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/dropzone/dropzone.css}" />
  
    <!-- Page CSS -->
    <link rel="stylesheet" th:href="@{/assets/vendor/css/pages/page-user-view.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/css/pages/app-chat.css}"/>
    <link th:href="@{https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/assets/vendor/css/pages/front-page-landing.css}"/>

    <!-- Helpers -->
    <script th:src="@{/assets/vendor/js/helpers.js}"></script>
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script th:src="@{/assets/js/config.js}"></script>
</head>
<body>
<!-- Layout wrapper -->
<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
        <!-- Menu -->

        <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
            <div class="app-brand demo">
                <a href="/" class="app-brand-link">
                  <span class="app-brand-logo demo">
                    <span style="color: var(--bs-primary)">
                        <img th:src="@{/images/logo.png}" width="38" height="38" alt="logo" class="app-logo-logo"/>
                    </span>
                  </span>
                    <span class="app-brand-text demo menu-text fw-semibold ms-2">DoCoroFile</span>
                </a>

                <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                                d="M8.47365 11.7183C8.11707 12.0749 8.11707 12.6531 8.47365 13.0097L12.071 16.607C12.4615 16.9975 12.4615 17.6305 12.071 18.021C11.6805 18.4115 11.0475 18.4115 10.657 18.021L5.83009 13.1941C5.37164 12.7356 5.37164 11.9924 5.83009 11.5339L10.657 6.707C11.0475 6.31653 11.6805 6.31653 12.071 6.707C12.4615 7.09747 12.4615 7.73053 12.071 8.121L8.47365 11.7183Z"
                                fill-opacity="0.9"/>
                        <path
                                d="M14.3584 11.8336C14.0654 12.1266 14.0654 12.6014 14.3584 12.8944L18.071 16.607C18.4615 16.9975 18.4615 17.6305 18.071 18.021C17.6805 18.4115 17.0475 18.4115 16.657 18.021L11.6819 13.0459C11.3053 12.6693 11.3053 12.0587 11.6819 11.6821L16.657 6.707C17.0475 6.31653 17.6805 6.31653 18.071 6.707C18.4615 7.09747 18.4615 7.73053 18.071 8.121L14.3584 11.8336Z"
                                fill-opacity="0.4"/>
                    </svg>
                </a>
            </div>

            <div class="menu-inner-shadow"></div>

            <ul class="menu-inner py-1">
                <li class="menu-item">
                    <a href="/" class="menu-link">
                        <i class="menu-icon tf-icons ri-home-smile-line"></i>
                        <div data-i18n="Home">Home</div>
                    </a>
                </li>
                <li id="li-library" class="menu-item">
                    <a href="/library" class="menu-link">
                        <i class="menu-icon tf-icons ri-box-3-line"></i>
                        <div data-i18n="Library">Library</div>
                    </a>
                </li>
                <li id="li-chat" class="menu-item">
                    <a href="/chats" class="menu-link">
                        <i class="menu-icon tf-icons ri-wechat-line"></i>
                        <div data-i18n="Chat">Chat</div>
                    </a>
                </li>
                <li id="li-upload" class="menu-item">
                    <a href="/documents/uploads" onclick="handleUploadClick(event)" class="menu-link">
                        <i class="menu-icon tf-icons ri-chat-upload-line"></i>
                        <div data-i18n="Upload">Upload</div>
                    </a>
                </li>
                <li id="li-pricing" class="menu-item">
                    <a href="/member/payment/pricing" class="menu-link">
                        <i class="menu-icon tf-icons ri-price-tag-2-line"></i>
                        <div data-i18n="Membership">Membership</div>
                    </a>
                </li>
                <li id="li-follow-course" class="menu-item">
                    <a href="/member/courses" class="menu-link">
                        <i class="menu-icon tf-icons ri-box-2-line"></i>
                        <div data-i18n="Course followed">Course followed</div>
                    </a>
                </li>
                <li id="li-manage-users" class="menu-item d-none">
                    <a href="/admin/users" class="menu-link">
                        <i class="menu-icon tf-icons ri-folder-user-line"></i>
                        <div data-i18n="Manage users">Manage users</div>
                    </a>
                </li>
                <li id="li-manage-documents" class="menu-item d-none">
                    <a href="/documents/manage" class="menu-link">
                        <i class="menu-icon tf-icons ri-file-pdf-2-line"></i>
                        <div data-i18n="Manage documents">Manage documents</div>
                    </a>
                </li>
                <li id="li-manage-reports" class="menu-item d-none">
                    <a href="/moderator/reports" class="menu-link" id="a-manage-reports">
                        <i class="menu-icon tf-icons ri-flag-line"></i>
                        <div data-i18n="Manage reports">Manage reports</div>
                    </a>
                </li>
                <li id="li-manage-university" class="menu-item d-none">
                    <a href="/admin/universities" class="menu-link">
                        <i class="menu-icon tf-icons ri-school-line"></i>
                        <div data-i18n="Manage university">Manage university</div>
                    </a>
                </li>
                <li id="li-manage-course" class="menu-item d-none">
                    <a href="/admin/courses" class="menu-link">
                        <i class="menu-icon tf-icons ri-box-1-line"></i>
                        <div data-i18n="Manage course">Manage course</div>
                    </a>
                </li>
            </ul>
        </aside>
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
            <!-- Navbar -->

            <nav th:replace="~{fragments/shared/header :: header}">
            </nav>

            <!-- / Navbar -->

            <!-- Content wrapper -->
            <div class="content-wrapper">
                <!-- Content -->

                <div layout:fragment="content" class="container-fluid flex-grow-1 container-p-y">
                </div>
                <!-- / Content -->

                <!-- Footer -->
                <footer th:replace="~{fragments/shared/footer :: footer}"
                        class="content-footer footer bg-footer-theme">

                </footer>
                <!-- / Footer -->

                <div class="content-backdrop fade"></div>
            </div>
            <!-- Content wrapper -->
        </div>
        <!-- / Layout page -->
    </div>

    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>

    <!-- Drag Target Area To SlideIn Menu On Small Screens -->
    <div class="drag-target"></div>
</div>
<!-- / Layout wrapper -->

<!-- Bootstrap Toast Wrapper -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="bootstrapToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
        <div class="toast-header">
            <img id="toastIcon" th:src="@{/images/logo.png}" class="rounded me-2" alt="Logo" width="20" height="20">
            <strong id="toastTitle" class="me-auto">Th√¥ng b√°o</strong>
            <small id="toastTime">v·ª´a xong</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            ...
        </div>
    </div>
</div>

<script>
    function handleUploadClick(event) {
        event.preventDefault(); // Kh√¥ng cho chuy·ªÉn trang m·∫∑c ƒë·ªãnh

        fetch('/documents/uploads', {
            method: 'GET',
            credentials: 'include'
        })
            .then(res => {
                if (res.status === 403) {
                    window.location.href = '/error?status=403'; // Chuy·ªÉn ƒë·∫øn trang l·ªói
                } else if (res.ok) {
                    window.location.href = '/documents/uploads'; // Cho ph√©p chuy·ªÉn n·∫øu h·ª£p l·ªá
                } else {
                    window.location.href = '/error?status=' + res.status;
                }
            })
            .catch(err => {
                console.error(err);
                window.location.href = '/error?status=500';
            });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/v1/api/auth/current-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include' // ‚ö†Ô∏è QUAN TR·ªåNG: g·ª≠i cookie (JWT) k√®m request
            });

            if (!response.ok) {
                document.getElementById('li-notification').classList.add('d-none');
                throw new Error('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin ng∆∞·ªùi d√πng');
            }

            const result = await response.json();

            // In ra k·∫øt qu·∫£
            console.log('‚úÖ Current User Info:', result.data);

            // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng v√†o UI
            document.getElementById('fullName').innerText = result.data.name || 'Kh√°ch';
            document.getElementById('membershipName').innerText = result.data.current_plan || 'GUEST';
            if (result.data.role === 'ROLE_MODERATOR') {
                document.getElementById('membershipName').classList.add('text-danger');
                document.getElementById('badge-role').classList.remove('d-none');
                document.getElementById('li-upload').classList.add('d-none');
                document.getElementById('li-chat').classList.add('d-none');
                document.getElementById('li-library').classList.add('d-none');
                document.getElementById('li-pricing').classList.add('d-none');
                document.getElementById('li-manage-reports').classList.remove('d-none');
                document.getElementById('a-manage-reports').href = '/moderator/manage-reports';
                document.getElementById('li-notification').classList.add('d-none');
                document.getElementById('profile-dropdown-menu').classList.add('d-none');
                document.getElementById('li-follow-course').classList.add('d-none');
            } else if (result.data.role === 'ROLE_ADMIN') {
                document.getElementById('membershipName').innerText = 'Admin';
                document.getElementById('membershipName').classList.add('text-danger');
                document.getElementById('badge-role').classList.remove('d-none');
                document.getElementById('li-upload').classList.add('d-none');
                document.getElementById('li-chat').classList.add('d-none');
                document.getElementById('li-library').classList.add('d-none');
                document.getElementById('li-pricing').classList.add('d-none');
                document.getElementById('li-manage-users').classList.remove('d-none');
                document.getElementById('li-manage-documents').classList.remove('d-none');
                document.getElementById('li-manage-reports').classList.remove('d-none');
                document.getElementById('a-manage-reports').href = '/admin/manage-reports';
                document.getElementById('li-manage-university').classList.remove('d-none');
                document.getElementById('li-manage-course').classList.remove('d-none');
                document.getElementById('li-notification').classList.add('d-none');
                document.getElementById('profile-dropdown-menu').classList.add('d-none');
                document.getElementById('li-follow-course').classList.add('d-none');
            }

            fetch("/v1/api/users/stats", {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include' // ‚ö†Ô∏è QUAN TR·ªåNG: g·ª≠i cookie (JWT) k√®m request
            })
                .then(response => response.json())
                .then(res => {
                    if (res.statusCode === 200 && res.data) {
                        const stats = res.data;
                        document.getElementById("total-users").textContent = stats.totalUsers ?? 0;
                        document.getElementById("premium-users").textContent = stats.totalMembersWithPlan ?? 0;
                        document.getElementById("total-members").textContent = stats.totalMembers ?? 0;
                        document.getElementById("inactive-users").textContent = stats.inactiveMembers ?? 0;
                    } else {
                        console.warn("Failed to load user stats");
                    }
                })
                .catch(err => {
                    console.error("Error fetching user stats:", err);
                });
        } catch (err) {
            console.error('‚ùå L·ªói khi l·∫•y th√¥ng tin ng∆∞·ªùi d√πng:', err);

            // C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng v√†o UI
            document.getElementById('fullName').innerText = 'Ng∆∞·ªùi d√πng';
            document.getElementById('membershipName').innerText = 'Th√†nh vi√™n';

            // üëâ Hide protected dropdown items
            const protectedItems = [
                'profile-dropdown-menu',
                'setting-dropdown-menu',
                'faq-dropdown-menu'
            ];
            protectedItems.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            const btn = document.getElementById('auth-button');
            if (btn) {
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-outline-primary');
                btn.setAttribute('href', '/auth/login');
                btn.innerHTML = `
                    <small class="align-middle">Login</small>
                    <i class="ri-login-box-line ms-2 ri-16px"></i>
                `;
            }
        }

        const form = document.getElementById("addNewUserForm");

        if (form) {
            form.addEventListener("submit", async function (e) {
                e.preventDefault(); // ‚ùó NgƒÉn reload trang


            })
        }
    });
</script>
<script th:src="@{/assets/pdfjs/pdf.min.js}"></script>
<script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = '/assets/pdfjs/pdf.worker.min.js';
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const docElem = document.getElementById('documentInfo');
        if (!docElem) return;
        const documentId = docElem.getAttribute('data-id');
        const commentContainer = document.getElementById('commentList');

        loadDocumentInfo();

        function showLoginAlert(message) {
            Swal.fire({
                icon: 'warning',
                title: 'Ch∆∞a ƒëƒÉng nh·∫≠p',
                text: message || 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c.',
                showCancelButton: true,
                confirmButtonText: 'ƒêƒÉng nh·∫≠p',
                cancelButtonText: 'ƒê√≥ng'
            }).then(result => {
                if (result.isConfirmed) {
                    window.location.href = `/auth/login?returnTo=${encodeURIComponent(window.location.pathname)}`;
                }
            });
        }

        function loadDocumentInfo() {
            // === Load Document Info ===
            fetch(`/v1/api/documents/view/${documentId}`)
                .then(res => res.json())
                .then(res => {
                    if (res.statusCode >= 400) {
                        // N√©m v·ªÅ trang l·ªói, k√®m theo status n·∫øu mu·ªën
                        window.location.href = `/error?status=${res.statusCode}`;
                        return; // d·ª´ng lu√¥n
                    }

                    const doc = res.data;
                    document.getElementById("documentTitle").innerText = doc.title;
                    document.getElementById("documentAuthor").innerText = doc.authorName;
                    document.getElementById("documentCourse").innerText = doc.courseName;
                    document.getElementById("documentUniv").innerText = doc.universityName;
                    document.getElementById("documentUpload").innerText = new Date(doc.uploadedDate).toLocaleDateString();
                    document.getElementById("documentLikes").innerText = doc.likes;
                    document.getElementById("documentDislikes").innerText = doc.dislikes;
                    document.getElementById("documentView").innerText = doc.views;
                    loadFile(doc.fileUrl);
                    renderComments(doc.comments || []);
                })
                .catch(err => {
                    console.error("L·ªói kh√¥ng x√°c ƒë·ªãnh", err);
                    window.location.href = "/error?status=500";
                });
        }

        function renderComments(comments) {
            commentContainer.innerHTML = ''; // Xo√° h·∫øt comment c≈©
            comments.forEach(renderComment);
        }

        function renderComment(comment) {
            const div = document.createElement('div');
            div.className = "d-flex align-items-start mb-4";

            const replyLink = document.createElement('a');
            replyLink.href = "#commentInput";
            replyLink.innerText = "Ph·∫£n h·ªìi";
            replyLink.onclick = function () {
                replyToComment(comment.authorName, comment.commentId);
            };

            const repliesHTML = renderReplies(comment.replies);

            div.innerHTML = `
        <div class="me-3"><img src="/assets/img/avatars/1.png" class="rounded-circle" width="40"></div>
        <div>
            <strong>${comment.authorName}</strong> <small>${formatDate(comment.createdOn)}</small>
            <p>${comment.content}</p>
            <div class="reply-placeholder"></div>
            ${repliesHTML}
            <hr/>
        </div>
    `;

            // G·∫Øn th·∫ª replyLink v√†o div .reply-placeholder
            div.querySelector(".reply-placeholder").appendChild(replyLink);

            commentContainer.appendChild(div);
        }

        function renderReplies(replies) {
            return (replies || []).map(reply => `
            <div class="ms-4 mt-2">
                <strong>${reply.authorName}</strong> <small>${formatDate(reply.createdOn)}</small>
                <p>${reply.content}</p>
                <a href="#commentInput" onclick="replyToComment('${reply.authorName}', '${reply.commentId}')">Ph·∫£n h·ªìi</a>
            </div>
        `).join('');
        }

        function replyToComment(authorName, commentId) {
            const input = document.getElementById("commentInput");
            const hidden = document.getElementById("parentCommentId");
            hidden.value = commentId; // üü¢ g√°n parent comment ID v√†o hidden field

            input.focus(); // focus v√†o khung nh·∫≠p
            input.value = `@${authorName} `; // mention ng∆∞·ªùi ƒë∆∞·ª£c reply
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
        }

        // === G·ª≠i b√¨nh lu·∫≠n ===
        document.getElementById('commentForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const content = document.getElementById('commentInput').value.trim();
            const parentCommentId = document.getElementById('parentCommentId').value.trim() || null;

            if (!content.trim()) {
                Swal.fire('L·ªói', 'B√¨nh lu·∫≠n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!', 'error');
                return;
            }

            const formData = new URLSearchParams();
            formData.append('content', content);
            formData.append('documentId', documentId);
            if (parentCommentId !== null) {
                formData.append('parentCommentId', parentCommentId);
            }

            fetch('/v1/api/comments/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData,
                credentials: 'include'
            })
                .then(res => res.json())
                .then(res => {
                    if (res.statusCode === 200) {
                        document.getElementById('commentInput').value = '';
                        document.getElementById('parentCommentId').value = '';
                        loadDocumentInfo(); // thay v√¨ reload
                    } else if (res.statusCode === 401 || res.statusCode === 403) {
                        showLoginAlert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ g·ª≠i b√¨nh lu·∫≠n!');
                    } else {
                        Swal.fire('L·ªói', res.message, 'error');
                    }
                })
                .catch(() => Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ g·ª≠i b√¨nh lu·∫≠n!', 'error'));
        });

        function loadFile(fileUrl) {
            const container = document.getElementById('pdf-container');
            container.innerHTML = '';

            if (!fileUrl.endsWith('.pdf')) return;

            fetch('/v1/api/auth/current-user', {
                method: 'POST',
                credentials: 'include'
            })
                .then(res => {
                    if (!res.ok) {
                        return renderPdf(fileUrl, 3); // GUEST
                    }
                    return res.json();
                })
                .then(userRes => {
                    if (!userRes) return;
                    const user = userRes.data;
                    const role = user.role;
                    const userId = user.id;

                    console.log("Current user:", user);

                    // N·∫øu l√† ADMIN ho·∫∑c MODERATOR th√¨ load full
                    if (role === 'ROLE_ADMIN' || role === 'ROLE_MODERATOR') {
                        return renderPdf(fileUrl, null); // null = kh√¥ng gi·ªõi h·∫°n
                    }
                    // N·∫øu l√† MEMBER th√¨ ki·ªÉm tra membership
                    if (role === 'ROLE_MEMBER') {
                        return fetch(`/v1/api/user/checkMembership/${userId}`, {
                            method: 'POST',
                            credentials: 'include'
                        })
                            .then(res => res.json())
                            .then(memRes => {
                                console.log("Membership check result:", memRes);
                                const hasPremium = memRes.data === true;
                                return renderPdf(fileUrl, hasPremium ? null : 3);
                            });
                    }
                    return renderPdf(fileUrl, 3);
                })
                .catch(() => renderPdf(fileUrl, 3));
        }

        function renderPdf(fileUrl, pageLimit) {
            const container = document.getElementById('pdf-container');
            container.innerHTML = '';

            pdfjsLib.GlobalWorkerOptions.workerSrc = '/assets/pdfjs/pdf.worker.min.js';
            pdfjsLib.getDocument(fileUrl).promise.then(pdf => {
                const totalPages = pdf.numPages;
                const pagesToRender = pageLimit ? Math.min(pageLimit, totalPages) : totalPages;

                for (let i = 1; i <= pagesToRender; i++) {
                    pdf.getPage(i).then(page => {
                        const scale = 1.5;
                        const viewport = page.getViewport({ scale });
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        page.render({ canvasContext: ctx, viewport });
                        canvas.classList.add('pdf-page');
                        container.appendChild(canvas);
                    });
                }

                if (pageLimit && pageLimit < totalPages) {
                    const notice = document.createElement('div');
                    notice.className = "alert alert-warning mt-3";
                    notice.innerText = "B·∫°n c·∫ßn t√†i kho·∫£n Premium ƒë·ªÉ xem to√†n b·ªô t√†i li·ªáu.";
                    container.appendChild(notice);
                }
            });
        }

        document.getElementById("downloadBtn").addEventListener("click", function () {
            fetch(`/v1/api/documents/download/${documentId}`, {
                method: "GET",
                credentials: "include"
            })
                .then(async res => {
                    if(res.url.includes("/error")) {
                        window.location.href = res.url;
                        return null;
                    }
                    if (!res.ok) {
                        const contentType = res.headers.get("Content-Type");

                        // X·ª≠ l√Ω n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
                        if (res.status === 401) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Ch∆∞a ƒëƒÉng nh·∫≠p',
                                text: 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫£i t√†i li·ªáu.',
                                showCancelButton: true,
                                confirmButtonText: 'ƒêƒÉng nh·∫≠p',
                                cancelButtonText: 'ƒê√≥ng'
                            }).then(result => {
                                if (result.isConfirmed) {
                                    window.location.href = `/auth/login?returnTo=${encodeURIComponent(window.location.pathname)}`;
                                }
                            });
                            return null;
                        }

                        // N·∫øu tr·∫£ v·ªÅ JSON (v√≠ d·ª•: h·∫øt l∆∞·ª£t t·∫£i)
                        if (contentType && contentType.includes("application/json")) {
                            const data = await res.json();
                            if (data.redirectToUpload) {
                                return Swal.fire({
                                    icon: 'warning',
                                    title: 'H·∫øt l∆∞·ª£t t·∫£i!',
                                    text: data.message || 'B·∫°n ƒë√£ h·∫øt l∆∞·ª£t t·∫£i t√†i li·ªáu.',
                                    showCancelButton: true,
                                    confirmButtonText: 'T·∫£i t√†i li·ªáu l√™n ƒë·ªÉ nh·∫≠n l∆∞·ª£t t·∫£i',
                                    cancelButtonText: 'ƒê√≥ng'
                                }).then(result => {
                                    if (result.isConfirmed) {
                                        window.location.href = `/documents/uploads?returnTo=${encodeURIComponent(window.location.pathname)}`;
                                    }
                                });
                            } else {
                                return Swal.fire('L·ªói', data.message || 'Kh√¥ng th·ªÉ t·∫£i t√†i li·ªáu.', 'error');
                            }
                        }

                        // N·∫øu tr·∫£ v·ªÅ plain text
                        const text = await res.text();
                        Swal.fire('L·ªói', "L·ªói t·∫£i xu·ªëng: " + text, 'error');
                        return null;
                    }

                    // N·∫øu th√†nh c√¥ng
                    return res.blob();
                })
                .then(blob => {
                    if (!blob) return;

                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `document_${documentId}.pdf`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(err => {
                    console.error("Download error:", err);
                    Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ t·∫£i t√†i li·ªáu.', 'error');
                });
        });

        fetch(`/v1/api/documents/related/${documentId}`, {
            credentials: 'include'
        })
            .then(res => res.json())
            .then(res => {
                const container = document.getElementById("relatedDocumentsContainer");
                if (!res.data.content || res.data.content.length === 0) {
                    container.innerHTML = '<p class="text-muted">No related documents found.</p>';
                    return;
                }

                res.data.content.forEach(doc => {
                    const col = document.createElement("div");
                    col.className = "col-md-4 mb-4";

                    col.innerHTML = `
                    <div class="card h-100 shadow-sm border-0" style="cursor: pointer;" onclick="window.location.href='/documents/${doc.documentId}'">
                        <img src="${doc.coverImageUrl}" class="card-img-top" style="height: 180px; object-fit: cover;" alt="cover image">
                        <div class="card-body">
                            <h5 class="card-title text-truncate" title="${doc.title}">${doc.title}</h5>
                            <p class="card-text text-muted text-truncate">${doc.description || "No description."}</p>
                        </div>
                        <div class="card-footer bg-white d-flex justify-content-between small text-muted px-3 py-2">
                            <div class="d-flex gap-3 align-items-center small text-muted">
                                <div class="d-flex align-items-center gap-1">
                                    <i class="ri-thumb-up-line text-success"></i><span>${doc.likes}</span>
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <i class="ri-thumb-down-line text-danger"></i><span>${doc.dislikes}</span>
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <i class="ri-eye-line text-secondary"></i><span>${doc.viewCount}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                    container.appendChild(col);
                });
            })
            .catch(err => {
                console.error("Failed to load related documents:", err);
            });

        const likeBtn = document.getElementById('likeBtn');
        const dislikeBtn = document.getElementById('dislikeBtn');
        const favBtn = document.getElementById('favBtn');

        let userReact = null;

        // === G·ªçi API ƒë·ªÉ bi·∫øt user ƒë√£ like/dislike g√¨ ch∆∞a
        fetch(`/v1/api/reactions/status?documentId=${documentId}`, { credentials: 'include' })
            .then(res => res.json())
            .then(res => {
                if (res.statusCode === 200) {
                    userReact = res.data; // 'like', 'dislike', or null
                    updateIcons(); // c·∫≠p nh·∫≠t icon theo tr·∫°ng th√°i ban ƒë·∫ßu
                }
            });

        // === X·ª≠ l√Ω nh·∫•n Like
        likeBtn.addEventListener("click", () => {
            const isUnlike = userReact === 'like';
            fetch('/v1/api/reactions/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                credentials: 'include',
                body: new URLSearchParams({
                    documentId,
                    isLike: !isUnlike,
                    isDislike: false
                })
            })
                .then(res => res.json())
                .then(res => {
                    if (res.statusCode !== 200) {
                        showLoginAlert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ƒë·ªÉ b√†y t·ªè c·∫£m x√∫c v·ªõi t√†i li·ªáu n√†y.');
                        return;
                    }

                    // N·∫øu like th√†nh c√¥ng
                    userReact = isUnlike ? null : 'like';
                    updateIcons();
                    refreshReactionCounts();
                    location.reload(); // reload l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng like/dislike
                })
                .catch(() => {
                    Swal.fire("L·ªói", "Kh√¥ng th·ªÉ g·ª≠i ph·∫£n ·ª©ng.", "error");
                });
        });

        // === X·ª≠ l√Ω nh·∫•n Dislike
        dislikeBtn.addEventListener("click", () => {
            const isUnDislike = userReact === 'dislike';
            fetch('/v1/api/reactions/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                credentials: 'include',
                body: new URLSearchParams({
                    documentId,
                    isLike: false,
                    isDislike: !isUnDislike
                })
            })
                .then(res => res.json())
                .then(res => {
                    if (res.statusCode !== 200) {
                        showLoginAlert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ƒë·ªÉ b√†y t·ªè c·∫£m x√∫c v·ªõi t√†i li·ªáu n√†y.');
                        return; // D·ª´ng ·ªü ƒë√¢y n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p
                    }

                    // N·∫øu th√†nh c√¥ng ‚Üí c·∫≠p nh·∫≠t icon
                    userReact = isUnDislike ? null : 'dislike';
                    updateIcons();
                    refreshReactionCounts();
                    location.reload(); // reload l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng like/dislike
                })
                .catch(() => {
                    Swal.fire("L·ªói", "Kh√¥ng th·ªÉ g·ª≠i ph·∫£n ·ª©ng.", "error");
                });
        });

        function updateIcons() {
            // Reset
            likeBtn.classList.remove("ri-thumb-up-fill", "ri-thumb-up-line");
            dislikeBtn.classList.remove("ri-thumb-down-fill", "ri-thumb-down-line");

            // Set l·∫°i theo tr·∫°ng th√°i
            if (userReact === 'like') {
                likeBtn.classList.add("ri-thumb-up-fill");
                dislikeBtn.classList.add("ri-thumb-down-line");
            } else if (userReact === 'dislike') {
                likeBtn.classList.add("ri-thumb-up-line");
                dislikeBtn.classList.add("ri-thumb-down-fill");
            } else {
                likeBtn.classList.add("ri-thumb-up-line");
                dislikeBtn.classList.add("ri-thumb-down-line");
            }
        }

        function refreshReactionCounts() {
            fetch(`/v1/api/documents/count/${documentId}`, {
                credentials: 'include'
            })
                .then(res => res.json())
                .then(res => {
                    const doc = res.data;
                    document.getElementById("documentLikes").innerText = doc.likes;
                    document.getElementById("documentDislikes").innerText = doc.dislikes;
                });
        }

        // === 3. Check tr·∫°ng th√°i y√™u th√≠ch ban ƒë·∫ßu ===
        fetch(`/v1/api/favorites/check?documentId=${documentId}`, { credentials: 'include' })
            .then(res => res.json())
            .then(res => {
                if (res.statusCode === 200 && res.data === true) {
                    favBtn.classList.remove('ri-heart-line');
                    favBtn.classList.add('ri-heart-fill');
                    favBtn.classList.add('text-danger');
                }
            });

        window.toggleFavorite = function () {
            const isSaved = favBtn.classList.contains('ri-heart-fill');
            const url = isSaved
                ? `/v1/api/favorites/remove?documentId=${documentId}`
                : `/v1/api/favorites/add?documentId=${documentId}`;
            const method = isSaved ? "DELETE" : "POST";

            fetch(url, {
                method: method,
                credentials: 'include'
            })
                .then(res => res.json())
                .then(res => {
                    if (res.statusCode === 200) {
                        favBtn.classList.toggle('ri-heart-line');
                        favBtn.classList.toggle('ri-heart-fill');
                        favBtn.classList.toggle('text-danger');
                        Swal.fire("Th√†nh c√¥ng", res.message, "success");
                    } else {
                        showLoginAlert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ƒë·ªÉ b√†y t·ªè c·∫£m x√∫c v·ªõi t√†i li·ªáu n√†y.');
                    }
                })
                .catch(() => {
                    Swal.fire("L·ªói", "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t y√™u th√≠ch!", "error");
                });
        };

        // === 5. Share (copy link) ===
        window.handleShare = function () {
            const link = `${window.location.origin}/documents/${documentId}`;
            navigator.clipboard.writeText(link)
                .then(() => Swal.fire("ƒê√£ sao ch√©p!", "Link ƒë√£ ƒë∆∞·ª£c copy v√†o clipboard.", "success"))
                .catch(() => Swal.fire("L·ªói", "Kh√¥ng th·ªÉ sao ch√©p link!", "error"));
        };
    });
</script>

<!-- Core JS -->
<!-- build:js assets/vendor/js/core.js -->
<script th:src="@{/assets/vendor/libs/jquery/jquery.js}"></script>
<script th:src="@{/assets/vendor/libs/popper/popper.js}"></script>
<script th:src="@{/assets/vendor/js/bootstrap.js}"></script>
<script th:src="@{/assets/vendor/libs/node-waves/node-waves.js}"></script>
<script th:src="@{/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js}"></script>
<script th:src="@{/assets/vendor/libs/hammer/hammer.js}"></script>
<script th:src="@{/assets/vendor/libs/i18n/i18n.js}"></script>
<script th:src="@{/assets/vendor/libs/typeahead-js/typeahead.js}"></script>
<script th:src="@{/assets/vendor/js/menu.js}"></script>
<script th:src="@{/assets/js/forms-file-upload.js}"></script>

<!-- endbuild -->

<!-- Vendors JS -->
<script th:src="@{/assets/vendor/libs/moment/moment.js}"></script>
<script th:src="@{/assets/vendor/libs/datatables-bs5/datatables-bootstrap5.js}"></script>
<script th:src="@{/assets/vendor/libs/select2/select2.js}"></script>
<script th:src="@{/assets/vendor/libs/@form-validation/popular.js}"></script>
<script th:src="@{/assets/vendor/libs/@form-validation/bootstrap5.js}"></script>
<script th:src="@{/assets/vendor/libs/@form-validation/auto-focus.js}"></script>
<script th:src="@{/assets/vendor/libs/cleavejs/cleave.js}"></script>
<script th:src="@{/assets/vendor/libs/cleavejs/cleave-phone.js}"></script>
<script th:src="@{/assets/vendor/libs/sweetalert2/sweetalert2.js}"></script>
<script th:src="@{/assets/vendor/libs/tagify/tagify.js}"></script>
<script th:src="@{/assets/vendor/libs/nouislider/nouislider.js}"></script>
<script th:src="@{/assets/vendor/libs/swiper/swiper.js}"></script>
<script th:src="@{/assets/vendor/js/menu.js}"></script>
<script th:src="@{/assets/vendor/libs/dropzone/dropzone.js}"></script>
<script th:src="@{/assets/js/forms-file-upload.js}"></script>

<!-- Main JS -->
<script th:src="@{/assets/js/main.js}"></script>
<script th:src="@{/assets/js/front-main.js}"></script>

<!-- Page JS -->
<script th:src="@{/assets/js/front-page-landing.js}"></script>
<script th:src="@{/assets/js/app-user-list.js}"></script>
<script th:src="@{/assets/js/modal-edit-user.js}"></script>
<script th:src="@{/assets/js/app-user-view.js}"></script>
<script th:src="@{/assets/js/app-user-view-account.js}"></script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const toastEl = document.getElementById('bootstrapToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');
        const toastTime = document.getElementById('toastTime');

        let successMessage = /*[[${success}]]*/ null;
        let errorMessage = /*[[${error}]]*/ null;

        if (successMessage) {
            toastTitle.innerText = "Th√†nh c√¥ng";
            toastMessage.innerText = successMessage;
            toastTime.innerText = "v·ª´a xong";
            toastIcon.src = "/images/success.png"; // optional: your own icon
            new bootstrap.Toast(toastEl).show();
        }

        if (errorMessage) {
            toastTitle.innerText = "Th·∫•t b·∫°i";
            toastMessage.innerText = errorMessage;
            toastTime.innerText = "v·ª´a xong";
            toastIcon.src = "/images/error.png"; // optional: your own icon
            new bootstrap.Toast(toastEl).show();
        }
    });
</script>

<!-- Hook cho scripts ri√™ng t·ª´ng trang -->
<div layout:fragment="scripts"></div>

<script th:src="@{/js/dropdown_notifications.js}"></script>

</body>
</html>
