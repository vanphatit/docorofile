<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="en"
      class="light-style layout-navbar-fixed layout-menu-fixed layout-wide"
      dir="ltr"
      data-theme="theme-default"
      data-template="vertical-menu-template"
      data-style="light">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title th:utext="${pageTitle}">DoCoroFile</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" th:href="@{/images/logo.png}"/>

    <!-- Fonts -->
    <link rel="preconnect" th:href="@{https://fonts.googleapis.com}"/>
    <link rel="preconnect" th:href="@{https://fonts.gstatic.com}" crossorigin/>
    <!--    <link-->
    <!--            th:href="@{https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&ampdisplay=swap}"-->
    <!--            rel="stylesheet" />-->

    <!-- Icons -->
    <link rel="stylesheet" th:href="@{/assets/vendor/fonts/remixicon/remixicon.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/fonts/flag-icons.css}"/>

    <!-- Menu waves for no-customizer fix -->
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/node-waves/node-waves.css}"/>

    <!-- Core CSS -->
    <link rel="stylesheet" th:href="@{/assets/vendor/css/rtl/core.css}" class="template-customizer-core-css"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/css/rtl/theme-default.css}" class="template-customizer-theme-css"/>
    <link rel="stylesheet" th:href="@{/assets/css/demo.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/css/pages/front-page.css}"/>

    <!-- Vendors CSS -->
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/typeahead-js/typeahead.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/datatables-bs5/datatables.bootstrap5.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/datatables-responsive-bs5/responsive.bootstrap5.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/datatables-buttons-bs5/buttons.bootstrap5.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/datatables-checkboxes-jquery/datatables.checkboxes.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/select2/select2.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/@form-validation/form-validation.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/animate-css/animate.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/sweetalert2/sweetalert2.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/tagify/tagify.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/nouislider/nouislider.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/libs/swiper/swiper.css}"/>

    <!-- Page CSS -->
    <link rel="stylesheet" th:href="@{/assets/vendor/css/pages/page-user-view.css}"/>
    <link rel="stylesheet" th:href="@{/assets/vendor/css/pages/app-chat.css}"/>
    <link th:href="@{https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/assets/vendor/css/pages/front-page-landing.css}"/>

    <!-- Helpers -->
    <script th:src="@{/assets/vendor/js/helpers.js}"></script>
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script th:src="@{/assets/js/config.js}"></script>
</head>
<body>
<!-- Layout wrapper -->
<div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
        <!-- Menu -->

        <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
            <div class="app-brand demo">
                <a href="/" class="app-brand-link">
                  <span class="app-brand-logo demo">
                    <span style="color: var(--bs-primary)">
                        <img th:src="@{/images/logo.png}" width="38" height="38" alt="logo" class="app-logo-logo"/>
                    </span>
                  </span>
                    <span class="app-brand-text demo menu-text fw-semibold ms-2">DoCoroFile</span>
                </a>

                <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large ms-auto">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                                d="M8.47365 11.7183C8.11707 12.0749 8.11707 12.6531 8.47365 13.0097L12.071 16.607C12.4615 16.9975 12.4615 17.6305 12.071 18.021C11.6805 18.4115 11.0475 18.4115 10.657 18.021L5.83009 13.1941C5.37164 12.7356 5.37164 11.9924 5.83009 11.5339L10.657 6.707C11.0475 6.31653 11.6805 6.31653 12.071 6.707C12.4615 7.09747 12.4615 7.73053 12.071 8.121L8.47365 11.7183Z"
                                fill-opacity="0.9"/>
                        <path
                                d="M14.3584 11.8336C14.0654 12.1266 14.0654 12.6014 14.3584 12.8944L18.071 16.607C18.4615 16.9975 18.4615 17.6305 18.071 18.021C17.6805 18.4115 17.0475 18.4115 16.657 18.021L11.6819 13.0459C11.3053 12.6693 11.3053 12.0587 11.6819 11.6821L16.657 6.707C17.0475 6.31653 17.6805 6.31653 18.071 6.707C18.4615 7.09747 18.4615 7.73053 18.071 8.121L14.3584 11.8336Z"
                                fill-opacity="0.4"/>
                    </svg>
                </a>
            </div>

            <div class="menu-inner-shadow"></div>

            <ul class="menu-inner py-1">
                <li class="menu-item">
                    <a href="/" class="menu-link">
                        <i class="menu-icon tf-icons ri-home-smile-line"></i>
                        <div data-i18n="Home">Home</div>
                    </a>
                </li>
                <li id="li-library" class="menu-item">
                    <a href="/" class="menu-link">
                        <i class="menu-icon tf-icons ri-box-3-line"></i>
                        <div data-i18n="Library">Library</div>
                    </a>
                </li>
                <li id="li-chat" class="menu-item">
                    <a href="/chats" class="menu-link">
                        <i class="menu-icon tf-icons ri-wechat-line"></i>
                        <div data-i18n="Chat">Chat</div>
                    </a>
                </li>
                <li id="li-upload" class="menu-item">
                    <a href="/documents/uploads" class="menu-link">
                        <i class="menu-icon tf-icons ri-chat-upload-line"></i>
                        <div data-i18n="Upload">Upload</div>
                    </a>
                </li>
                <li id="li-pricing" class="menu-item">
                    <a href="/member/payment/pricing" class="menu-link">
                        <i class="menu-icon tf-icons ri-price-tag-2-line"></i>
                        <div data-i18n="Membership">Membership</div>
                    </a>
                </li>
                <li id="li-manage-users" class="menu-item d-none">
                    <a href="/moderator/reports" class="menu-link">
                        <i class="menu-icon tf-icons ri-folder-user-line"></i>
                        <div data-i18n="Manage users">Manage users</div>
                    </a>
                </li>
                <li id="li-manage-documents" class="menu-item d-none">
                    <a href="/" class="menu-link">
                        <i class="menu-icon tf-icons ri-file-pdf-2-line"></i>
                        <div data-i18n="Manage documents">Manage documents</div>
                    </a>
                </li>
                <li id="li-manage-reports" class="menu-item d-none">
                    <a href="/moderator/reports" class="menu-link">
                        <i class="menu-icon tf-icons ri-flag-line"></i>
                        <div data-i18n="Manage reports">Manage reports</div>
                    </a>
                </li>
                <li id="li-manage-university" class="menu-item d-none">
                    <a href="/" class="menu-link">
                        <i class="menu-icon tf-icons ri-school-line"></i>
                        <div data-i18n="Manage university">Manage university</div>
                    </a>
                </li>
                <li id="li-manage-course" class="menu-item d-none">
                    <a href="/" class="menu-link">
                        <i class="menu-icon tf-icons ri-box-1-line"></i>
                        <div data-i18n="Manage course">Manage course</div>
                    </a>
                </li>
            </ul>
        </aside>
        <!-- / Menu -->

        <!-- Layout container -->
        <div class="layout-page">
            <!-- Navbar -->

            <nav th:replace="~{fragments/shared/header :: header}">
            </nav>

            <!-- / Navbar -->

            <!-- Content wrapper -->
            <div class="content-wrapper">
                <!-- Content -->

                <div layout:fragment="content" class="container-fluid flex-grow-1 container-p-y">
                </div>
                <!-- / Content -->

                <!-- Footer -->
                <footer th:replace="~{fragments/shared/footer :: footer}"
                        class="content-footer footer bg-footer-theme">

                </footer>
                <!-- / Footer -->

                <div class="content-backdrop fade"></div>
            </div>
            <!-- Content wrapper -->
        </div>
        <!-- / Layout page -->
    </div>

    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>

    <!-- Drag Target Area To SlideIn Menu On Small Screens -->
    <div class="drag-target"></div>
</div>
<!-- / Layout wrapper -->

<!-- Bootstrap Toast Wrapper -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
    <div id="bootstrapToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
        <div class="toast-header">
            <img id="toastIcon" th:src="@{/images/logo.png}" class="rounded me-2" alt="Logo" width="20" height="20">
            <strong id="toastTitle" class="me-auto">Thông báo</strong>
            <small id="toastTime">vừa xong</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            ...
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/v1/api/auth/current-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include' // ⚠️ QUAN TRỌNG: gửi cookie (JWT) kèm request
            });

            if (!response.ok) {
                throw new Error('Không thể lấy thông tin người dùng');
            }

            const result = await response.json();

            // ✅ In ra kết quả
            console.log('✅ Current User Info:', result.data);

            // Cập nhật thông tin người dùng vào UI
            document.getElementById('fullName').innerText = result.data.name || 'Người dùng';
            document.getElementById('membershipName').innerText = result.data.current_plan || 'Thành viên';
            if (result.data.role === 'ROLE_MODERATOR') {
                document.getElementById('membershipName').innerText = 'Moderator';
                document.getElementById('membershipName').classList.add('text-danger');
                document.getElementById('badge-role').classList.remove('d-none');
                document.getElementById('li-upload').classList.add('d-none');
                document.getElementById('li-chat').classList.add('d-none');
                document.getElementById('li-library').classList.add('d-none');
                document.getElementById('li-pricing').classList.add('d-none');
                document.getElementById('li-manage-reports').classList.remove('d-none');
            } else if (result.data.role === 'ROLE_ADMIN') {
                document.getElementById('membershipName').innerText = 'Admin';
                document.getElementById('membershipName').classList.add('text-danger');
                document.getElementById('badge-role').classList.remove('d-none');
                document.getElementById('li-upload').classList.add('d-none');
                document.getElementById('li-chat').classList.add('d-none');
                document.getElementById('li-library').classList.add('d-none');
                document.getElementById('li-pricing').classList.add('d-none');
                document.getElementById('li-manage-users').classList.remove('d-none');
                document.getElementById('li-manage-documents').classList.remove('d-none');
                document.getElementById('li-manage-reports').classList.remove('d-none');
                document.getElementById('li-manage-university').classList.remove('d-none');
                document.getElementById('li-manage-course').classList.remove('d-none');
            }

            fetch("/v1/api/users/stats", {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include' // ⚠️ QUAN TRỌNG: gửi cookie (JWT) kèm request
            })
                .then(response => response.json())
                .then(res => {
                    if (res.statusCode === 200 && res.data) {
                        const stats = res.data;
                        document.getElementById("total-users").textContent = stats.totalUsers ?? 0;
                        document.getElementById("premium-users").textContent = stats.totalMembersWithPlan ?? 0;
                        document.getElementById("total-members").textContent = stats.totalMembers ?? 0;
                        document.getElementById("inactive-users").textContent = stats.inactiveMembers ?? 0;
                    } else {
                        console.warn("Failed to load user stats");
                    }
                })
                .catch(err => {
                    console.error("Error fetching user stats:", err);
                });
        } catch (err) {
            console.error('❌ Lỗi khi lấy thông tin người dùng:', err);

            // Cập nhật thông tin người dùng vào UI
            document.getElementById('fullName').innerText = 'Người dùng';
            document.getElementById('membershipName').innerText = 'Thành viên';

            // 👉 Hide protected dropdown items
            const protectedItems = [
                'profile-dropdown-menu',
                'setting-dropdown-menu',
                'faq-dropdown-menu'
            ];
            protectedItems.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            const btn = document.getElementById('auth-button');
            if (btn) {
                btn.classList.remove('btn-danger');
                btn.classList.add('btn-outline-primary');
                btn.setAttribute('href', '/auth/login');
                btn.innerHTML = `
                    <small class="align-middle">Login</small>
                    <i class="ri-login-box-line ms-2 ri-16px"></i>
                `;
            }
        }

        const form = document.getElementById("addNewUserForm");

        if (form) {
            form.addEventListener("submit", async function (e) {
                e.preventDefault(); // ❗ Ngăn reload trang


            })
        }
    });
</script>

<!-- Core JS -->
<!-- build:js assets/vendor/js/core.js -->
<script th:src="@{/assets/vendor/libs/jquery/jquery.js}"></script>
<script th:src="@{/assets/vendor/libs/popper/popper.js}"></script>
<script th:src="@{/assets/vendor/js/bootstrap.js}"></script>
<script th:src="@{/assets/vendor/libs/node-waves/node-waves.js}"></script>
<script th:src="@{/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js}"></script>
<script th:src="@{/assets/vendor/libs/hammer/hammer.js}"></script>
<script th:src="@{/assets/vendor/libs/i18n/i18n.js}"></script>
<script th:src="@{/assets/vendor/libs/typeahead-js/typeahead.js}"></script>
<script th:src="@{/assets/vendor/js/menu.js}"></script>

<!-- endbuild -->

<!-- Vendors JS -->
<script th:src="@{/assets/vendor/libs/moment/moment.js}"></script>
<script th:src="@{/assets/vendor/libs/datatables-bs5/datatables-bootstrap5.js}"></script>
<script th:src="@{/assets/vendor/libs/select2/select2.js}"></script>
<script th:src="@{/assets/vendor/libs/@form-validation/popular.js}"></script>
<script th:src="@{/assets/vendor/libs/@form-validation/bootstrap5.js}"></script>
<script th:src="@{/assets/vendor/libs/@form-validation/auto-focus.js}"></script>
<script th:src="@{/assets/vendor/libs/cleavejs/cleave.js}"></script>
<script th:src="@{/assets/vendor/libs/cleavejs/cleave-phone.js}"></script>
<script th:src="@{/assets/vendor/libs/sweetalert2/sweetalert2.js}"></script>
<script th:src="@{/assets/vendor/libs/tagify/tagify.js}"></script>
<script th:src="@{/assets/vendor/libs/nouislider/nouislider.js}"></script>
<script th:src="@{/assets/vendor/libs/swiper/swiper.js}"></script>
<script th:src="@{/assets/vendor/js/menu.js}"></script>

<!-- Main JS -->
<script th:src="@{/assets/js/main.js}"></script>
<script th:src="@{/assets/js/front-main.js}"></script>

<!-- Page JS -->
<script th:src="@{/assets/js/front-page-landing.js}"></script>
<script th:src="@{/assets/js/app-user-list.js}"></script>
<script th:src="@{/assets/js/modal-edit-user.js}"></script>
<script th:src="@{/assets/js/app-user-view.js}"></script>
<script th:src="@{/assets/js/app-user-view-account.js}"></script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const toastEl = document.getElementById('bootstrapToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');
        const toastIcon = document.getElementById('toastIcon');
        const toastTime = document.getElementById('toastTime');

        let successMessage = /*[[${success}]]*/ null;
        let errorMessage = /*[[${error}]]*/ null;

        if (successMessage) {
            toastTitle.innerText = "Thành công";
            toastMessage.innerText = successMessage;
            toastTime.innerText = "vừa xong";
            toastIcon.src = "/images/success.png"; // optional: your own icon
            new bootstrap.Toast(toastEl).show();
        }

        if (errorMessage) {
            toastTitle.innerText = "Thất bại";
            toastMessage.innerText = errorMessage;
            toastTime.innerText = "vừa xong";
            toastIcon.src = "/images/error.png"; // optional: your own icon
            new bootstrap.Toast(toastEl).show();
        }
    });
</script>

<!-- Hook cho scripts riêng từng trang -->
<div layout:fragment="scripts"></div>

<script th:src="@{/js/dropdown_notifications.js}"></script>

</body>
</html>
